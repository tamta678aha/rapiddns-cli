name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Test
        run: go test ./...

      - name: Build Artifacts
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME}"
          mkdir -p dist

          targets=(
            "linux amd64"
            "linux arm64"
            "darwin amd64"
            "darwin arm64"
            "windows amd64"
          )

          for target in "${targets[@]}"; do
            GOOS="$(awk '{print $1}' <<< "${target}")"
            GOARCH="$(awk '{print $2}' <<< "${target}")"

            ext=""
            if [ "${GOOS}" = "windows" ]; then
              ext=".exe"
            fi

            folder="rapiddns_${VERSION}_${GOOS}_${GOARCH}"
            bin="rapiddns${ext}"

            mkdir -p "dist/${folder}"
            env CGO_ENABLED=0 GOOS="${GOOS}" GOARCH="${GOARCH}" \
              go build -trimpath -ldflags "-s -w" -o "dist/${folder}/${bin}" .

            if [ "${GOOS}" = "windows" ]; then
              (cd dist && zip -qr "${folder}.zip" "${folder}")
            else
              (cd dist && tar -czf "${folder}.tar.gz" "${folder}")
            fi

            rm -rf "dist/${folder}"
          done

          (cd dist && sha256sum *.tar.gz *.zip > checksums.txt)

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          generate_release_notes: true
